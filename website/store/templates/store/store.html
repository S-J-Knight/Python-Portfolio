{% extends 'store/main.html' %}
{% load static %}

{% block content %}
<style>
  .stock-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-block;
    margin-top: 8px;
  }
  .stock-badge.in-stock {
    background: #d1fae5;
    color: #065f46;
  }
  .stock-badge.low-stock {
    background: #fef3c7;
    color: #92400e;
  }
  .stock-badge.out-of-stock {
    background: #fee2e2;
    color: #991b1b;
  }
  .recycle-card.out-of-stock-product {
    opacity: 0.6;
  }
  .recycle-card.out-of-stock-product .recycle-img {
    filter: grayscale(50%);
  }
</style>
  <!-- Filter Form -->
  <form method="get" class="form-inline mb-4">
    <label for="product_type" class="mr-2 font-weight-bold">Material:</label>
    <select name="product_type" id="product_type" class="form-control mr-3">
      <option value="">All</option>
      {% for code, label in product_type_choices %}
        <option value="{{ code }}" {% if selected_product_type == code %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <label for="colour" class="mr-2 font-weight-bold">Colour:</label>
    <select name="colour" id="colour" class="form-control mr-3">
      <option value="">All</option>
      {% for code, label in colour_choices %}
        <option value="{{ code }}" {% if selected_colour == code %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-success">Filter</button>
  </form>
<div class="store-grid">
  <div class="row">
    {% for product in products %}
      <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
        <article class="recycle-card recycle-card--small {% if not product.is_in_stock %}out-of-stock-product{% endif %}">
          <div class="recycle-media">
            {% if product.image %}
              <a href="{% url 'store:product_detail' product.slug %}">
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="recycle-img">
              </a>
            {% else %}
              <div class="recycle-img placeholder">No image</div>
            {% endif %}
          </div>

          <div class="recycle-info" style="text-align:center;">
            <h5 class="product-name"><a href="{% url 'store:product_detail' product.slug %}">{{ product.name }}</a></h5>
            
            {% if product.is_on_sale and product.sale_price %}
              <div class="price-container" style="margin:8px 0;">
                <span class="original-price" style="text-decoration:line-through; color:#6b7280; font-size:0.9rem;">Â£{{ product.price|floatformat:2 }}</span>
                <span class="sale-price" style="color:#dc2626; font-size:1.3rem; font-weight:700; margin-left:8px;">Â£{{ product.sale_price|floatformat:2 }}</span>
                <span class="savings-badge" style="background:#dc2626; color:white; padding:2px 8px; border-radius:4px; font-size:0.75rem; margin-left:8px; font-weight:600;">
                  Save {{ product.savings_percent }}%
                </span>
              </div>
              {% if product.sale_comment %}
                <p style="color:#dc2626; font-size:0.85rem; font-weight:600; margin:4px 0;">{{ product.sale_comment }}</p>
              {% endif %}
            {% else %}
              <p class="price">Â£{{ product.price|floatformat:2 }}</p>
            {% endif %}
            
            <p class="card-text" style="margin-bottom:8px;">
              <strong>Material:</strong> {{ product.product_type }} | <strong>Colour:</strong> {{ product.colour }}
            </p>
            
            {% if product.review_count > 0 %}
              <div style="color:#f59e0b; font-size:1.1rem; margin:8px 0;">
                {{ product.get_star_display }}
                <span style="color:#6b7280; font-size:0.85rem; margin-left:4px;">({{ product.average_rating }}) {{ product.review_count }} review{{ product.review_count|pluralize }}</span>
                {% if product.has_review_photos %}
                  <span style="color:#10b981; margin-left:4px;" title="Customer photos available">ðŸ“·</span>
                {% endif %}
              </div>
            {% else %}
              <div style="color:#9ca3af; font-size:0.85rem; margin:8px 0;">No reviews yet</div>
            {% endif %}

            <span class="stock-badge {{ product.stock_status_class }}">
              {{ product.stock_status }}
            </span>

            <div class="actions" style="display:flex; flex-direction:column; gap:8px; align-items:stretch; margin-top:12px;">
              {% if product.is_in_stock %}
                <div style="display:flex; gap:8px;">
                  <input id="qty-{{ product.id }}" class="form-control qty-input" type="number" value="1" min="1" max="{{ product.stock_quantity }}" style="width:70px; text-align:center; flex-shrink:0;">
                  <button class="btn btn-success update-cart"
                      data-product="{{ product.id }}"
                      data-action="add"
                      data-qty-input="qty-{{ product.id }}"
                      style="flex:1;">
                    Add to basket
                  </button>
                </div>
              {% else %}
                <button class="btn btn-secondary" disabled style="width:100%;">
                  Out of Stock
                </button>
              {% endif %}
              <a class="btn btn-outline-primary" href="{% url 'store:product_detail' product.slug %}" style="width:100%;">View</a>
            </div>
          </div>
        </article>
      </div>
    {% empty %}
      <div class="col-12"><p>No products available.</p></div>
    {% endfor %}
  </div>
</div>
{% endblock %}