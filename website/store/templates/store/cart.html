{% extends 'store/main.html' %}
{% load static %}

{% block content %}
<style>
:root{
  --accent:#116944; --danger:#b91c1c; --muted:#6b7280; --border:#e5e7eb;
}

/* Stack: summary first, items below */
.cart-layout{
  display:flex;
  flex-direction:column;
  gap:16px;
  align-items:stretch;
}
.cart-right{ order:-1; }           /* move summary to the top */
@media (min-width: 992px){
  .cart-right{ position:static; }  /* disable sticky in stacked layout */
}

/* Boxes */
.summary-box,.points-box,.box-element{
  background:#fff;
  border:1px solid var(--border);
  border-radius:10px;
  box-shadow:0 1px 2px rgba(0,0,0,.04);
}
.summary-box{ padding:14px; }
.points-box{ padding:14px; text-align:center; }
.points-box h6{ color:var(--accent); margin-bottom:12px; }

/* Summary lines */
.sum-line{
  display:grid;
  grid-template-columns:1fr auto;
  gap:12px;
  align-items:center;
  margin:8px 0;
  font-size:1rem;
}
.sum-line .amount{ text-align:right; font-variant-numeric:tabular-nums; letter-spacing:.02em; }
.sum-line.discount{ color:#128e4d; font-weight:500; }

/* Total */
.sum-line.grand-total{
  grid-template-columns:1fr;
  justify-items:center;
  border-top:2px solid var(--border);
  padding-top:14px;
  margin-top:12px;
}
.sum-line.grand-total .label{ font-size:1rem; color:#374151; margin-bottom:4px; }
.sum-line.grand-total .total-amount{ font-weight:800; font-size:1.8rem; line-height:1.1; color:var(--danger); }

/* Points controls */
.chip{ display:inline-block; background:#e6f4ea; color:#116944; border:1px solid #c8e7d2; border-radius:999px; padding:2px 8px; font-size:.75rem; margin-left:6px; }
.redeem-row{ display:flex; gap:10px; margin:12px 0; flex-wrap:wrap; justify-content:center; }
.redeem-input{ max-width:220px; text-align:center; }
.btn-checkout{ margin:16px auto 0; display:block; max-width:280px; }

/* Cart quantity column (compact) */
.cart-row .qty-cell{
  display:flex;
  align-items:center;
  gap:8px;
  justify-content:flex-end;
  min-width: 150px;      /* narrower since no Update button */
}
.qty-input{
  width: 48px;
  text-align:center;
  padding:2px 6px;
  font-size:.95rem;
  font-variant-numeric:tabular-nums;
}
.qty-input::-webkit-outer-spin-button,
.qty-input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
.qty-input[type=number]{ -moz-appearance:textfield; }
.qty-controls{ display:flex; align-items:center; gap:8px; }

.muted{ font-size:0.9rem; color:var(--muted); margin:8px 0; }
</style>

<section class="section uncentered" id="cart-page">
  <div class="container">
    <!-- Back button -->
    <div class="box-element">
      <a class="btn btn-outline-dark" href="{% url 'store:store' %}">‚Üê Continue Shopping</a>
    </div>

    <!-- Two column layout -->
    <div class="cart-layout">
      
      <!-- LEFT COLUMN -->
      <div class="cart-left">
        
        <!-- Points Redemption -->
        {% if customer and available_points > 0 %}
        <div class="points-box">
          <h6>üíé Redeem Points</h6>
          <p class="muted">
            Available: <strong>{{ available_points }} points</strong> (¬£{{ available_points_gbp|floatformat:2 }})
          </p>
          <!-- Replace the redeem-row section in cart.html -->
          <div class="redeem-row">
            <input type="number" id="points-input" min="0" max="{{ max_points_usable }}" 
                   value="{{ order.points_used }}" placeholder="Enter points" class="redeem-input">
            <button onclick="applyPoints()" class="btn btn-primary">Apply</button>
            <button onclick="clearPoints()" class="btn btn-outline-secondary">Clear</button>
          </div>
          <p class="muted">1 point = 1p ‚Ä¢ Max {{ max_points_usable }} points for this cart</p>
        </div>
        {% endif %}

        <!-- Cart Items -->
        <div class="box-element">
          <h5 style="margin-bottom:15px">Cart Items ({{ order.get_cart_items }})</h5>
          
          <!-- Header row -->
          <div class="cart-row">
            <div></div>
            <div><strong>Item</strong></div>
            <div><strong>Price</strong></div>
            <div><strong>Quantity</strong></div>
          </div>

          {% for item in items %}
          <div class="cart-row">
            <div>
              <img class="row-image" src="{{ item.product.imageURL }}">
            </div>
            <div>
              <p>{{ item.product.name }}</p>
            </div>
            <div>
              <p>¬£{{ item.product.price|floatformat:2 }}</p>
            </div>

            <!-- Quantity column (fixed) -->
            <div class="qty-cell">
              <div class="qty-controls">
                <img data-product="{{ item.product.id }}" data-action="remove"
                     class="chg-quantity update-cart" src="{% static 'images/arrow_down.png' %}">
                <input id="qty-{{ item.product.id }}" class="form-control form-control-sm qty-input" type="number"
                       value="{{ item.quantity }}" min="0" max="99" inputmode="numeric" pattern="[0-9]*">
                <img data-product="{{ item.product.id }}" data-action="add"
                     class="chg-quantity update-cart" src="{% static 'images/arrow_up.png' %}">
              </div>
              <!-- Update button removed -->
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="cart-right">
        <div class="summary-box">
          <h5>Order Summary</h5>

          <div class="sum-line">
            <span class="label">Subtotal</span>
            <span class="amount" id="cart-subtotal">¬£{{ order.get_cart_total|floatformat:2 }}</span>
          </div>

          {% if order.points_used > 0 %}
          <div class="sum-line discount">
            <span class="label">
              Points Discount
              <small class="chip">-{{ order.points_used }} pts</small>
            </span>
            <span class="amount">-¬£{{ order.points_discount_gbp|floatformat:2 }}</span>
          </div>
          {% endif %}

          <div class="sum-line grand-total {% if order.points_used > 0 %}is-discount{% endif %}">
            <span class="label">Total</span>
            <span class="total-amount">
              {% if order.points_used > 0 %}
                ¬£{{ order.get_cart_total_after_points|floatformat:2 }}
              {% else %}
                ¬£{{ order.get_cart_total|floatformat:2 }}
              {% endif %}
            </span>
          </div>

          <a class="btn btn-success btn-checkout" href="{% url 'store:checkout' %}">Proceed to Checkout</a>
        </div>
      </div>

    </div>
  </div>
</section>

<script>
function getCookie(name){
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

function applyPoints() {
  const points = parseInt(document.getElementById('points-input').value) || 0;
  
  // Disable buttons during request
  const applyBtn = event.target;
  const clearBtn = document.querySelector('button[onclick="clearPoints()"]');
  applyBtn.disabled = true;
  if (clearBtn) clearBtn.disabled = true;

  fetch('{% url "store:apply_points" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken'),
    },
    body: JSON.stringify({ points })
  })
  .then(r => r.json())
  .then((data) => { // fixed
    if (data.success) {
      updateDiscountDisplay(data.points_used, data.discount);
      document.querySelector('.total-amount').textContent = data.new_total;
    } else {
      alert(data.error || 'Failed to apply points');
    }
  })
  .catch(() => alert('Failed to apply points'))
  .finally(() => {
    // Re-enable buttons after request completes
    applyBtn.disabled = false;
    if (clearBtn) clearBtn.disabled = false;
  });
}

function updateDiscountDisplay(points, discount) {
  const discountLine = document.querySelector('.sum-line.discount');
  
  if (points > 0) {
    // Show or update discount line
    if (!discountLine) {
      // Create discount line if it doesn't exist
      const subtotalLine = document.querySelector('.sum-line:not(.discount):not(.grand-total)');
      const newLine = document.createElement('div');
      newLine.className = 'sum-line discount';
      newLine.innerHTML = `
        <span class="label">
          Points Discount
          <small class="chip">-${points} pts</small>
        </span>
        <span class="amount">-${discount}</span>
      `;
      subtotalLine.after(newLine);
    } else {
      // Update existing discount line
      discountLine.querySelector('.chip').textContent = `-${points} pts`;
      discountLine.querySelector('.amount').textContent = `-${discount}`;
    }
    
    // Add red color to total
    document.querySelector('.sum-line.grand-total').classList.add('is-discount');
  } else {
    // Remove discount line if points = 0
    if (discountLine) {
      discountLine.remove();
    }
    // Remove red color from total
    document.querySelector('.sum-line.grand-total').classList.remove('is-discount');
  }
}

function clearPoints() {
  document.getElementById('points-input').value = 0;
  applyPoints();
}
</script>
{% endblock content %}