{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all weight inputs
    const weightInputs = document.querySelectorAll('input[name*="weight_kg"]');
    const pointsField = document.querySelector('input[name="points_calculated"]');
    
    if (!pointsField) return;
    
    // Get plastic type point values (passed from backend)
    const plasticTypeRates = {{ plastic_type_rates|safe }};
    
    // Get user's membership tier
    const isPremium = {{ is_premium|default:"false"|lower }};
    
    function calculateTotalPoints() {
        let total = 0;
        
        // Loop through all material rows
        document.querySelectorAll('.tabular tr.has_original, .tabular tr.empty-form:not(.empty-form)').forEach(row => {
            if (row.classList.contains('empty-form')) return;
            
            const plasticSelect = row.querySelector('select[name*="plastic_type"]');
            const weightInput = row.querySelector('input[name*="weight_kg"]');
            const deleteCheckbox = row.querySelector('input[name*="DELETE"]');
            
            // Skip if marked for deletion
            if (deleteCheckbox && deleteCheckbox.checked) return;
            
            if (plasticSelect && weightInput && plasticSelect.value && weightInput.value) {
                const plasticTypeId = plasticSelect.value;
                const weight = parseFloat(weightInput.value);
                
                if (weight > 0 && plasticTypeRates[plasticTypeId]) {
                    const rate = isPremium ? 
                        plasticTypeRates[plasticTypeId].premium : 
                        plasticTypeRates[plasticTypeId].basic;
                    total += Math.floor(weight * rate);
                }
            }
        });
        
        return total;
    }
    
    function updateSuggestion() {
        const calculated = calculateTotalPoints();
        const suggestionDiv = document.getElementById('points-suggestion');
        
        if (suggestionDiv) {
            suggestionDiv.textContent = 'Suggested: ' + calculated + ' points (1 point per 10g)';
        }
    }
    
    // Create suggestion display
    const pointsFieldGroup = pointsField.closest('.form-row');
    if (pointsFieldGroup) {
        const suggestionDiv = document.createElement('div');
        suggestionDiv.id = 'points-suggestion';
        suggestionDiv.style.cssText = 'color:#666;font-size:0.9em;margin-top:5px;';
        pointsFieldGroup.appendChild(suggestionDiv);
        
        // Initial calculation
        updateSuggestion();
        
        // Listen for changes on existing and future elements
        document.addEventListener('input', function(e) {
            if (e.target.name && (e.target.name.includes('weight_kg') || e.target.name.includes('plastic_type'))) {
                updateSuggestion();
            }
        });
        
        document.addEventListener('change', function(e) {
            if (e.target.name && (e.target.name.includes('DELETE') || e.target.name.includes('plastic_type'))) {
                updateSuggestion();
            }
        });
        
        // Watch for new inline rows being added (Django's inline formset)
        const inlineContainer = document.querySelector('.tabular.inline-related');
        if (inlineContainer) {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length > 0) {
                        // New row added, recalculate
                        updateSuggestion();
                    }
                });
            });
            
            observer.observe(inlineContainer, {
                childList: true,
                subtree: true
            });
        }
    }
});
</script>
{% endblock %}

{% block field_sets %}
{{ block.super }}

{# Add canvas for admin signature field #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Give the DOM a moment to fully render
    setTimeout(function() {
        // Find the wtn_admin_signature textarea - try multiple selectors
        let signatureTextarea = document.querySelector('textarea[name="wtn_admin_signature"]');
        
        if (!signatureTextarea) {
            signatureTextarea = document.querySelector('textarea[id*="wtn_admin_signature"]');
        }
        
        if (!signatureTextarea) {
            signatureTextarea = document.querySelector('#id_wtn_admin_signature');
        }
        
        if (!signatureTextarea) {
            console.log('Signature textarea not found - tried multiple selectors');
            console.log('Available textareas:', document.querySelectorAll('textarea'));
            return;
        }
        
        console.log('Found signature textarea:', signatureTextarea.name || signatureTextarea.id);
        
        // Hide the textarea
        signatureTextarea.style.display = 'none';
        
        // Create canvas container
        const container = document.createElement('div');
        container.style.cssText = 'margin: 10px 0; padding: 15px; background: #f9fafb; border-radius: 8px; border: 2px solid #e5e7eb;';
        container.innerHTML = `
            <div style="margin-bottom: 10px;">
                <label for="admin-signature-pad" style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Admin's Signature (Required for WTN approval):</label>
                <canvas id="admin-signature-pad" width="600" height="200" style="border: 2px solid #116944; background-color: #ffffff; cursor: crosshair; touch-action: none; display: block; margin: 10px 0; border-radius: 4px;"></canvas>
                <button type="button" id="clear-admin-sig" style="background: #ef4444; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 8px;">üóëÔ∏è Clear Signature</button>
                <div id="sig-status" style="margin-top: 8px; font-size: 0.9rem; color: #6b7280;"></div>
            </div>
        `;
        
        // Insert canvas before the hidden textarea
        signatureTextarea.parentNode.insertBefore(container, signatureTextarea);
        
        // Now initialize the signature pad
        const canvas = document.getElementById('admin-signature-pad');
        const clearBtn = document.getElementById('clear-admin-sig');
        const statusDiv = document.getElementById('sig-status');
        const ctx = canvas.getContext('2d');
        let drawing = false;
        let hasSignature = false;
        
        function updateStatus() {
            if (hasSignature) {
                statusDiv.innerHTML = '‚úÖ <strong style="color: #10b981;">Signature captured</strong>';
            } else {
                statusDiv.innerHTML = '‚ö†Ô∏è <strong style="color: #ef4444;">No signature - please sign above</strong>';
            }
        }
        
        // Check if there's already a signature
        if (signatureTextarea.value && signatureTextarea.value.startsWith('data:image')) {
            const img = new Image();
            img.onload = function() {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                hasSignature = true;
                updateStatus();
            };
            img.src = signatureTextarea.value;
        } else {
            updateStatus();
        }
        
        // Drawing functions
        function startDrawing(e) {
            drawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.beginPath();
            ctx.moveTo(x, y);
            hasSignature = true;
        }
        
        function draw(e) {
            if (!drawing) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.lineTo(x, y);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
        }
        
        function stopDrawing() {
            drawing = false;
            if (hasSignature) {
                signatureTextarea.value = canvas.toDataURL('image/png');
                updateStatus();
                console.log('Signature saved to textarea');
            }
        }
        
        // Mouse events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        // Touch events
        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            startDrawing(e);
        });
        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
            draw(e);
        });
        canvas.addEventListener('touchend', function(e) {
            e.preventDefault();
            stopDrawing();
        });
        
        // Clear button
        clearBtn.addEventListener('click', function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            signatureTextarea.value = '';
            hasSignature = false;
            updateStatus();
            console.log('Signature cleared');
        });
        
        console.log('‚úÖ Admin signature canvas initialized successfully');
    }, 500); // Wait 500ms for DOM to fully render
});
</script>
{% endblock %}